(function(){"use strict";function j(t){throw new Error("Didn't expect to get here")}function b(t){if(!t)throw new Error(`Assert failed: ${t}`)}class D extends Error{constructor(e){super(e),this.name=this.constructor.name}}class V extends Error{constructor(e){super(e),this.name=this.constructor.name}}class F extends Error{constructor(e,n){super("GotoException"),this.name=this.constructor.name,this.jl=e,this.env=n}}class y{constructor(e,n){this.parent=n,this.variables=e}getFull(e){var n;for(let r=0;r<this.variables.length;r++)if(this.variables[r][0]===e)return{val:this.variables[r][1],instance:this};return(n=this.parent)==null?void 0:n.getFull(e)}setOnInstance(e,n){let r=!1;for(let a=0;a<this.variables.length;a++)if(this.variables[a][0]===e){this.variables[a][1]=n,r=!0;break}r||this.variables.push([e,n])}get(e){var n;return(n=this.getFull(e))==null?void 0:n.val}set(e,n){const r=this.getFull(e);return r===void 0?new y([[e,n]],this):(r.instance.setOnInstance(e,n),this)}}function C(t){switch(t.tag){case"none":return!1;case"int":return t.value!=0;default:throw Error(`Type ${t.tag} cannot be converted to true or false.`)}}function A(t,e){throw new V(`${t} ${e} could not be found in the current scope, are you sure it is spelled correctly?`)}function Z(t,e){switch(t.tag){case"internal_func":case"func":return!1;case"none":return e.tag=="none";case"int":return e.tag=="int";case"string":return e.tag=="string"}}function k(t,e){switch(t.tag){case"internal_func":case"func":return!1;case"none":return e.tag=="none";case"int":return e.tag=="int"&&t.value==e.value;case"string":return e.tag=="string"&&t.value==e.value}}function w(t,e){switch(t.tag){case"internal_func":case"func":case"none":return!1;case"int":return e.tag=="int"&&t.value<e.value;case"string":return!1}}function i(t,e,n){switch(n.tag){case"var":const r=e.get(n.name);return r==null&&A("Variable",n.name),{env:e,val:r};case"int":return{env:e,val:{tag:"int",value:n.value}};case"string":return{env:e,val:{tag:"string",value:n.value}};case"set":{let{env:f,val:d}=i(t,e,n.expr);return f=f.set(n.name,d),{env:f,val:d}}case"call":const a=e.get(n.name);switch(a==null&&A("Function",n.name),a.tag){case"func":if(a.args.length!=n.arguments.length)throw Error(`Tried calling function ${a.name} with ${n.arguments.length} arguments while the function expects ${a.args.length} arguments.`);let f=a.env,d=e;for(let v=0;v<a.args.length;v++){const p=i(t,d,n.arguments[v]);d=p.env,f=f.set(a.args[v],p.val)}return $(t,f,a.body),{env:d,val:{tag:"none"}};case"internal_func":{const v=[];let p=e;for(let S=0;S<n.arguments.length;S++){const z=i(t,p,n.arguments[S]);p=z.env,v.push(z.val)}return{env:p,val:a.func(t,e,v)}}default:throw Error(`Cannot call argument of type ${a.tag} as a function.`)}case"brackets":return i(t,e,n.expr);case"binary":const{env:s,val:o}=i(t,e,n.left),{env:c,val:u}=i(t,s,n.right);if(n.op=="+"||n.op=="-"||n.op=="*"||n.op=="/")if(o.tag=="int"&&u.tag=="int")switch(n.op){case"+":return{env:c,val:{tag:"int",value:o.value+u.value}};case"-":return{env:c,val:{tag:"int",value:o.value-u.value}};case"*":return{env:c,val:{tag:"int",value:o.value*u.value}};case"/":return{env:c,val:{tag:"int",value:o.value/u.value}}}else{if(n.op=="+"&&o.tag=="string"&&u.tag=="string")return{env:c,val:{tag:"string",value:o.value+u.value}};if(n.op=="*"&&o.tag=="string"&&u.tag=="int")return{env:c,val:{tag:"string",value:o.value.repeat(u.value)}};throw Error(`Cannot use operation ${n.op} between ${o.tag} and ${u.tag}`)}else{if(!Z(o,u))return{env:c,val:{tag:"int",value:0}};switch(n.op){case"==":return{env:c,val:{tag:"int",value:+k(o,u)}};case"!=":return{env:c,val:{tag:"int",value:+!k(o,u)}};case"<":return{env:c,val:{tag:"int",value:+w(o,u)}};case">=":return{env:c,val:{tag:"int",value:+!w(o,u)}};case">":return{env:c,val:{tag:"int",value:+(!w(o,u)&&!k(o,u))}};case"<=":return{env:c,val:{tag:"int",value:+(!w(o,u)||k(o,u))}}}}break;case"unary":const{env:l,val:m}=i(t,e,n.expr);if(m.tag!="int")throw Error(`Cannot use unary operator ${n.op} on ${m.tag}`);switch(n.op){case"-":return{env:l,val:{tag:"int",value:-m.value}};case"!":return{env:l,val:{tag:"int",value:+!m.value}}}}}function x(t,e,n){n.tag!=="scope"?i(t,e,n):$(t,e,n.statements)}function H(t,e,n){let r=n.unless,a=n.run;for(;;){if(r===void 0)return x(t,e,a),e;const s=i(t,e,r.condition);if(e=s.env,C(s.val)){if(r.then===void 0)return e;a=r.then.run,r=r.then.unless}else return x(t,e,a),e}}function J(t){return t[Math.floor(Math.random()*t.length)]}function $(t,e,n){for(const r of n)switch(r.tag){case"noop":break;case"expr":e=i(t,e,r.expr).env;break;case"scope":$(t,e,r.statements);break;case"if":e=H(t,e,r);break;case"goto":const a=r.identifier,s=t.jumpTable.get(a)??[],o=[];for(let u=0;u<s.length;u++){const l=s[u],{env:m,val:f}=l.cond!==void 0?i(t,e,l.cond):{env:e,val:{tag:"int",value:0}};C(f)||o.push({env:m,jl:l})}if(o.length===0)break;const c=J(o);throw new F(c.jl,c.env);default:j()}}function K(t,e){let n=e,r=X;for(;;){try{$(t,r,n)}catch(a){if(a instanceof F){n=a.jl.scope.slice(a.jl.numStatementsSkip),r=a.env;continue}else throw a}break}}function Q(t){switch(t.tag){case"internal_func":return`${t.name}(${t.args.join(", ")})`;case"func":return`${t.name}(${t.args.join(", ")})`;case"int":return`${t.value}`;case"string":return`${t.value}`;case"none":return"none"}}const W=[["print",(t,e,n)=>(t.log(n.map(Q).join(" ")),{tag:"none"})],["mod",(t,e,n)=>(b(n.length===2),b(n[0].tag==="int"),b(n[1].tag==="int"),{tag:"int",value:n[0].value%n[1].value})]],X=new y(W.map(([t,e])=>[t,{tag:"internal_func",name:t,args:[],func:e}]).concat([]));function M(t){const e=t.charCodeAt(0);return e>=65&&e<91||e>=97&&e<123||RegExp(/^\p{L}/,"u").test(t)}function P(t){return _(t)!=-1}function _(t){const e=t.charCodeAt(0);return e>=48&&e<58?e-48:-1}function Y(t,e,n){let r="";for(;e<t.length;e++){const o=t[e];if(M(o)||P(o))r+=o;else break}const a=n(r);let s;switch(r){case"true":s={tag:"true"};break;case"false":s={tag:"false"};break;case"unless":s={tag:"unless"};break;case"then":s={tag:"then"};break;case"come":s={tag:"come"};break;case"from":s={tag:"from"};break;default:s={tag:"identifier",value:r}}return{token:{token:s,loc:a},newPos:e}}function ee(t,e,n){let r=0;for(;e<t.length;e++){const o=t[e],c=_(o);if(c!=-1)r*=10,r+=c;else break}const a=n(r.toString());return{token:{token:{tag:"int",value:r},loc:a},newPos:e}}function I(t,e,n,r,a){const s=n.slice(r).match(t);return b(s!==null),b(s.length>0),{token:{token:e(s),loc:a(s[0])},newPos:r+s[0].length}}function te(t,e){return t.slice(e,e+2)==="//"}function ne(t,e,n){return I(/^\/\/ *(?<key>[a-zA-Z]\w*)?.*$/mu,s=>{var o;return{tag:"comment",key:(o=s.groups)==null?void 0:o.key}},t,e,n)}function re(t){return t==='"'||t==="'"}function ae(t,e,n){return I(/(["'])(?<value>[^\\]*?(?:\\.[^\\]*?)*)\1/mu,s=>({tag:"string",value:s.groups.value}),t,e,n)}function se(t,e){const n={...t},r=(e.match(/\n/g)||[]).length;return r==0?t.column+=e.length:(t.line+=r,t.column=e.length-e.lastIndexOf(`
`)),n}function oe(t,e,n){return t.slice(e,e+n.length)===n}function ce(t){const e=[];let n={line:1,column:1},r=s=>se(n,s),a=[["==",{tag:"equality",reverse:!1}],["!=",{tag:"equality",reverse:!0}],["<",{tag:"comparison",op:"<"}],[">",{tag:"comparison",op:">"}],["<=",{tag:"comparison",op:"<="}],[">=",{tag:"comparison",op:">="}],[" ",null],[`
`,null],["	",null],["\r",null],[";",{tag:"semicolon"}],[",",{tag:"comma"}],["(",{tag:"lbracket"}],[")",{tag:"rbracket"}],["{",{tag:"curlylbracket"}],["}",{tag:"curlyrbracket"}],["=",{tag:"assign"}],["+",{tag:"add"}],["-",{tag:"subtract"}],["*",{tag:"multiply"}],["/",{tag:"divide"}],["!",{tag:"bang"}]];e:for(let s=0;s<t.length;){if(te(t,s)){const{token:o,newPos:c}=ne(t,s,r);e.push(o),s=c;continue}for(let o=0;o<a.length;o++){const[c,u]=a[o];if(oe(t,s,c)){s+=c.length;const l=r(c);u!==null&&e.push({token:u,loc:l});continue e}}if(re(t[s])){const{token:o,newPos:c}=ae(t,s,r);e.push(o),s=c;continue}if(P(t[s])){const{token:o,newPos:c}=ee(t,s,r);e.push(o),s=c;continue}if(M(t[s])){const{token:o,newPos:c}=Y(t,s,r);e.push(o),s=c;continue}throw Error(`Unknown character "${t[s]}" at position line ${n.line} column ${n.column}.`)}return e.push({token:{tag:"eof"},loc:n}),e}function ue(t){if(t==null)return"undefined";let e;switch(t.tag){case"identifier":e=t.value;break;case"int":e=t.value.toString();break;default:e="";break}return e!=""&&(e=`(${e})`),t.tag+e}function ie(t){return"["+t.map(ue).join(", ")+"]"}function L(t,e){let n;return e.match("curlylbracket")?n={tag:"scope",statements:O(t,e)}:n=h(t,e),n}function N(t,e){if(e.match("unless"))return{tag:"unless",condition:h(t,e),then:le(t,e)}}function le(t,e){if(e.match("then"))return{tag:"then",run:L(t,e),unless:N(t,e)}}function O(t,e){const n=[];for(;;)switch(e.peek().tag){case"semicolon":e.consume("semicolon");break;case"eof":return n;case"curlyrbracket":return e.consume("curlyrbracket"),n;case"comment":const a=e.consume("comment");a.key!==void 0&&n.push({tag:"goto",identifier:a.key});break;case"come":e.consume("come"),e.consume("from");const s=e.consume("identifier").value,o=e.match("unless")?h(t,e):void 0,c=t.jumpTable.get(s)||[];c.push({scope:n,numStatementsSkip:n.length,cond:o}),t.jumpTable.set(s,c),e.consume("semicolon");break;default:{const u=L(t,e),l=N(t,e);if(l)n.push({tag:"if",run:u,unless:l});else if(u.tag=="scope")n.push(u);else{n.push({tag:"expr",expr:u}),e.consume("semicolon");break}}}}function ge(t,e){if(e.match("rbracket"))return[];const n=[h(t,e)];for(;;)switch(e.advance().tag){case"rbracket":return n;case"comma":const a=h(t,e);n.push(a);break;default:e.errExpected("closing bracket of function call or comma")}}function h(t,e){return fe(t,e)}function fe(t,e){let n=q(t,e),r;for(;r=e.match("equality");){const a=q(t,e);n={tag:"binary",left:n,right:a,op:r.reverse?"!=":"=="}}return n}function q(t,e){let n=U(t,e),r;for(;r=e.match("comparison");){const a=U(t,e);n={tag:"binary",left:n,right:a,op:r.op}}return n}function U(t,e){let n=R(t,e),r;for(;r=e.matchMul("add","subtract");){const a=R(t,e);n={tag:"binary",left:n,right:a,op:r.tag=="add"?"+":"-"}}return n}function R(t,e){let n=E(t,e),r;for(;r=e.matchMul("multiply","divide");){const a=E(t,e);n={tag:"binary",left:n,right:a,op:r.tag=="multiply"?"*":"/"}}return n}function E(t,e){if(e.matchMul("bang","subtract")){const n=e.previous();return{tag:"unary",expr:E(t,e),op:n.tag=="bang"?"!":"-"}}return he(t,e)}function he(t,e){const n=e.peek();switch(e.advance(),n.tag){case"identifier":return e.match("lbracket")?{tag:"call",name:n.value,arguments:ge(t,e)}:e.match("assign")?{tag:"set",name:n.value,expr:h(t,e)}:{tag:"var",name:n.value};case"int":return{tag:"int",value:n.value};case"string":return{tag:"string",value:n.value};case"true":return{tag:"int",value:1};case"false":return{tag:"int",value:0};case"lbracket":{const r=h(t,e);return e.advance().tag!="rbracket"&&e.errExpected("right bracket"),{tag:"brackets",expr:r}}default:e.errExpected("expression")}}function B(t,e){return t.tag=="scope"?T([t],e):" ".repeat(e)+g(t)}function G(t,e){return` unless ${g(t.condition)}${t.then?ve(t.then,e):";"}`}function ve(t,e){return` then ${B(t.run,e)}${t.unless?G(t.unless,e):";"}`}function me(t){return T(t,0)}function T(t,e){const n=" ".repeat(e);let r="";for(const a of t){switch(a.tag){case"expr":r+=n+g(a.expr)+";";break;case"noop":break;case"scope":r+=`${n}{
${T(a.statements,e+4)}
${n}}`;break;case"if":r+=`${B(a.run,e)}${G(a.unless,e)}`;break;case"goto":r+=`${n}// ${a.identifier}`;break;default:j()}r+=`
`}return r.slice(0,-1)}function g(t){switch(t.tag){case"var":return`${t.name}`;case"int":return`${t.value}`;case"string":return`"${t.value}"`;case"call":return`${t.name}(${t.arguments.map(g).join(", ")})`;case"brackets":return`(${g(t.expr)})`;case"binary":return`${g(t.left)} ${t.op} ${g(t.right)}`;case"unary":return`${t.op}${g(t.expr)}`;case"set":return`${t.name} = ${g(t.expr)}`}}class de{constructor(e){this.tokens=e,this.current=0}peekFull(){return this.tokens[this.current]}peek(){return this.peekFull().token}isAtEnd(){return this.peek().tag=="eof"}previousFull(){return this.tokens[this.current-1]}previous(){return this.previousFull().token}previousLoc(){return this.previousFull().loc}check(e){return this.isAtEnd()?!1:this.peek().tag==e}advance(){return this.isAtEnd()||this.current++,this.previous()}match(e){return this.matchMul(e)}matchMul(...e){for(const n of e)if(this.check(n))return this.advance(),this.previous()}errExpected(e,n){const a={...{peek:!1},...n},{token:s,loc:o}=a.peek?this.peekFull():this.previousFull();throw new D(`Expected ${e} but found ${s.tag} instead.

Line: ${o.line}, Column: ${o.column}.`)}consume(e){const n=this.matchMul(e);return n===void 0&&this.errExpected(e),n}}function pe(t,e){const r={...{verbose:!1,log:console.log},...e};r.verbose&&(console.log("Program:"),console.log(t),console.log("-".repeat(50)));const a=ce(t);r.verbose&&(console.log("Tokens:"),console.log(ie(a.map(u=>u.token))),console.log("-".repeat(50)));const s=new de(a),o={jumpTable:new Map,log:r.log},c=O(o,s);r.verbose&&(console.log("Program from AST:"),console.log(me(c)),console.log("-".repeat(50)),console.log("Program output:")),K(o,c)}onmessage=t=>{const e=t.data,n=(...r)=>{const a=r.map(s=>s.toString()).join(" ");postMessage({tag:"log",text:a})};try{pe(e,{log:n})}catch(r){postMessage({tag:"err",text:r.toString()})}postMessage({tag:"done"})}})();
